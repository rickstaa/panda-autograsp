# Ros kinetic panda_auto_grasp singularity container recipe
Bootstrap: docker
From: nvidia/cuda:10.0-cudnn7-devel-ubuntu16.04

%help
    HPC Singularity container containing ros_kinetic, tensorflow_gpu & miniconda3. For more information see https://github.com/rickstaa/deep_robotics_singularity_recipes.

    == Container aliases ==
    ccd:      Cd to home path of singularity root container
    rsource:  source ros kinetic setup file
    atf:      Activate tensorflow gpu conda enviroment
    dtf:      Deactivate tensorflow gpu conda enviroment

%labels
    Maintainer: Rick Staa
    Github: https://github.com/rickstaa
    Version: v0.0.5
    Type: Private

%environment

    ## Set language options ##
    LANG=C.UTF-8 LC_ALL=C.UTF-8

    ## Set ROS distro var ##
    ROS_DISTRO=kinetic

    ## Cuda samples env var ##
    export NVCUDASAMPLES_ROOT=/opt/NVIDIA_CUDA-10.0_Samples

    ## Libfreenect2 conf env var ##
    export LIBFREENECT2_INSTALL_PREFIX=/opt/freenect2/

    ## Freenect2 lib env var ##
    export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/opt/freenect2/lib

%post

    ## Install system package dependencies ##
    apt update --fix-missing
    apt install -q -y\
        wget \
        less \
        vim \
        git \
        bash-completion \
        htop \
        ssh \
		tar \
		libevent-dev \
        libncurses-dev \
        tmux \
		nautilus \
        gedit \
        x11-xserver-utils \
        ssh \
        software-properties-common \
        curl \
        bzip2 \
        iputils-ping \
        ca-certificates \
        figlet \
        dirmngr \
        gnupg2 \
        lsb-release \
        unzip \
        cmake \
        pkg-config \
        wget
    apt clean
    rm -rf /var/lib/apt/lists/*

    ## Fix system python dependencies
    apt update --fix-missing
    apt install -q -y\
        build-essential \
        python3 \
        python-dev \
        python3-dev \
        python-tk \
        python3-tk \
        python-opengl \
        libsm6 \
        libxext6 \
        libglib2.0-0 \
        libxrender1 \
	libgtk2.0-dev

    ## Install pip (`apt-get install python-pip` causes trouble w/ networkx).
    curl -O https://bootstrap.pypa.io/get-pip.py && \
	    python get-pip.py && \
        rm get-pip.py
    curl -O https://bootstrap.pypa.io/get-pip.py && \
	    python3 get-pip.py && \
        rm get-pip.py

    ## Install virtual env package ##
    python -m pip install virtualenv
    python2 -m pip install virtualenv

    ## Add container resources to the container ##
    bash -c "cd / \
        && git clone https://github.com/rickstaa/deep_robotics_singularity_recipes.git \
        && cp /deep_robotics_singularity_recipes/resources/.singularity_bashrc /.singularity_bashrc \
        && cp /deep_robotics_singularity_recipes/resources/.conda_init /.conda_init \
        && cp /deep_robotics_singularity_recipes/resources/.conda_wrapper /.conda_wrapper \
        && cp /deep_robotics_singularity_recipes/resources/welcome_msgs/ros_kinect-cuda10-xenial.txt /.welcome_msg \
        && rm -rf /deep_robotics_singularity_recipes"

    ## Install miniconda3 ##
    wget --quiet https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh -O /miniconda.sh
    /bin/bash /miniconda.sh -b -p /opt/conda
    rm /miniconda.sh
    /opt/conda/bin/conda clean -tipsy
    . /opt/conda/etc/profile.d/conda.sh
    conda install -q -y python=3
    conda update -y conda
    ln -s /opt/conda/etc/profile.d/conda.sh /etc/profile.d/conda.sh

    ## Add conda init and conda wrapper to .singularity_bashrc ##
    cat ./.welcome_msg >> ./.singularity_bashrc
    echo "" >> /.singularity_bashrc
    echo "## Source conda initialization script ##" >> /.singularity_bashrc
    echo ". /.conda_init" >> /.singularity_bashrc
    echo "" >> /.singularity_bashrc
    echo "## Source conda wrapper script ##" >> /.singularity_bashrc
    echo ". /.conda_wrapper" >> /.singularity_bashrc
    echo "" >> /.singularity_bashrc
    echo "## Activate tf-gpu enviroment" >> /.singularity_bashrc
    echo "conda activate tf-gpu" >> /.singularity_bashrc
    rm /.welcome_msg # Remove welcome message file

    ## Create tf-gpu enviroment ##
    conda create -q -y --name tf-gpu python==3.7
    conda activate tf-gpu
    pip install rospkg

    ## Install python packages ##
    conda install -y tensorflow-gpu
    #conda install -y jupyter
    conda update --all

    ## Install pip (`apt-get install python-pip` causes trouble w/ networkx).
    curl -O https://bootstrap.pypa.io/get-pip.py && \
	    python get-pip.py && \
        rm get-pip.py
    curl -O https://bootstrap.pypa.io/get-pip.py && \
	    python3 get-pip.py && \
        rm get-pip.py

    ## setup ROS keys and sources.list ##
    echo "deb http://packages.ros.org/ros/ubuntu $(lsb_release -sc) main" > /etc/apt/sources.list.d/ros-latest.list
    apt-key adv --keyserver 'hkp://keyserver.ubuntu.com:80' --recv-key C1CF6E31E6BADE8868B172B4F42ED6FBAB17C654

    # install ROS bootstrap tools
    apt update
    apt install --no-install-recommends -y\
        python-rosdep \
        python-rosinstall \
        python-vcstools
    rm -rf /var/lib/apt/lists/*

    # bootstrap rosdep
    rosdep init
    rosdep update

    ## Install ROS kinetic desktop full ##
    apt update
    apt install -q -y ros-kinetic-desktop-full

    ## Install MoveIt and check for panda_auto_grasp package dependencies
    rosdep update
    apt update
    apt dist-upgrade -y
    apt install -q -y ros-kinetic-catkin python-catkin-tools
    apt install -q -y ros-kinetic-moveit
    apt install -q -y \
       ros-kinetic-moveit-ros-move-group \
       ros-kinetic-controller-manager* \
       ros-kinetic-moveit* \
       ros-kinetic-effort-controllers \
       ros-kinetic-joint-trajectory-controller \
       ros-kinetic-gazebo-ros* \
       ros-kinetic-rviz* \
       ros-kinetic-joint-state-controller* \
       libboost-filesystem-dev \
       libjsoncpp-dev

    ## Install libfranca from source ##
    bash -c "cd / \
        && apt install -q -y ros-kinetic-libfranka ros-kinetic-franka-ros \
        && apt install -q -y libpoco-dev libeigen3-dev \
        && apt remove -y "*libfranka*" \
        && git clone --recursive https://github.com/frankaemika/libfranka.git \
        && cd /libfranka \
        && mkdir build \
        && cd build \
        && cmake -DCMAKE_BUILD_TYPE=Release .. \
        && cmake --build ."

    ## Download cuda10.0 samples and set cmake variables ##
    bash -c "cd /opt \
        && git clone https://github.com/zchee/cuda-sample.git \
        && mv cuda-sample NVIDIA_CUDA-10.0_Samples"
    export NVCUDASAMPLES_ROOT=/opt/NVIDIA_CUDA-10.0_Samples

    ## Install kinect2.0 Library ##
    apt update
    apt install -q -y \
        libusb-1.0-0-dev \
        libturbojpeg \
        libjpeg-turbo8-dev \
        libglfw3-dev \
        libva-dev \
        libjpeg-dev \
        libopenni2-dev \
        openni2-utils
    bash -c "cd /opt \
        && git clone https://github.com/OpenKinect/libfreenect2.git \
        && cd libfreenect2 \
        && mkdir -p build \
        && cd build \
        && cmake .. -DCMAKE_INSTALL_PREFIX=/opt/freenect2 \
        && make \
        && make install \
        && mkdir -p /etc/udev/rules.d/ \
        && cp ../platform/linux/udev/90-kinect2.rules /etc/udev/rules.d/ \
        && make install-openni2"

    ## Install opencv ##
    conda install -y -c conda-forge opencv

    ## Upgrade packages and remove unused packages ##
    apt -q -y upgrade
    apt autoremove
    apt autoclean
    rm -rf /var/lib/apt/lists/*

%runscript

	## Execute the .singularity_bashrc file ##
	OCI_CMD='/bin/bash'
	OCI_ARGS='-rcfile /.singularity_bashrc'
	SINGULARITY_OCI_RUN="${OCI_CMD} ${OCI_ARGS}"
	exec $SINGULARITY_OCI_RUN
